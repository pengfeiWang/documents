document.addEventListener("DOMContentLoaded",function(){var s=document,c=s.querySelectorAll(".tool")[0],i=s.getElementById("tool-side"),q=s.getElementById("tool-nav-user"),h=s.getElementById("tool-nav"),b=q.querySelectorAll(".select-dep")[0],d=q.querySelectorAll(".select-pro")[0],n=s.getElementById("add-category"),k=s.getElementById("edit-ok"),p=s.getElementById("create-doc"),a=s.getElementById("edit-doc"),m=s.getElementById("edit-cancel"),j=!!s.documentElement.getAttribute("data-user");function g(t){if(t.keyCode===8){t.preventDefault();return}}if(window.location.pathname=="/"){a&&a.setAttribute("hidden",true);d.disabled=true;b.options[0].selected=d.options[0].selected=true}function r(u){var t=$("#ifr")[0];return u?t.contentWindow.editor:t}function f(){return s.documentElement.getAttribute("data-user")}function l(u,t){$.ui.mask.show({tipText:u,autoHide:2000,showCallBack:function(){if(t){window.location.href=t;return}window.location.reload()}})}function e(){}function o(){}$.on(b,"change",function(y){var w=this;var u=w.value;var A=r();var x=r("inp");d.options[0].selected=true;var z=['<option value="">选择文档</option>',"{%~it:c:i%}",'<option value="{%=c._id%}" {%?c.selected%}selected{%?%}>{%=c.name%}</option>',"{%~%}"].join("");if(u){d.removeAttribute("disabled");$.ajax({url:"/project",type:"post",data:{departmentId:u},success:function(B){var t=0;var D=B.result;var v=['<div>输入文档名称: <input type="text" name="pro"></div>'].join("");if(!B.status){$.ui.msgbox({msg:"暂无文档, 是否立即创建",type:"confirm",callBack:{okFn:function(){if(B.userName){$.ui.msgbox({title:"创建文档",msg:v,type:"confirm",callBack:{preInput:function(){var E=this.okBtn,G=this.content;E.disabled=true;E.classList.add("disabled");var F=G.querySelectorAll("input")[0];this.inp=F;$.on(F,"input",function(){if(this.value){E.removeAttribute("disabled");E.classList.remove("disabled")}else{E.disabled=true;E.classList.add("disabled")}})},okFn:function(){var E=this.inp.value;var G=r();var F='<option>选择文档</option><option value="'+E+'" selected>'+E+"</option>";d.innerHTML=F;w.disabled=d.disabled=true;p.setAttribute("hidden",true);a.setAttribute("hidden",true);m.removeAttribute("hidden");k.removeAttribute("hidden");i.setAttribute("hidden",true);h=document.getElementById("tool-nav");h.innerHTML="";G.src="/static/create.html";document.documentElement.setAttribute("data-create-doc",true)},cancelFn:function(){window.location.reload()}}})}else{$.ui.msgbox({msg:"未登录用户不能创建文档",type:"alert",callBack:{okFn:function(){d.options[0].selected=true;d.disabled=true;w.options[0].selected=true;document.documentElement.removeAttribute("data-create-doc")}}})}},cancelFn:function(){window.location.reload();return}}})}else{var C=$.doT(z,D);d.removeAttribute("disabled");d.innerHTML=C}}})}else{window.location.reload();return}});$.on(d,"change",function(){var v=b.value;var t=this.value;var w=r();var u=r("inp");p&&p.setAttribute("hidden",true);m&&m.setAttribute("hidden",true);k&&k.setAttribute("hidden",true);if(j){a.removeAttribute("hidden")}if(!v){$.ui.msgbox({msg:"请选择部门"});return}if(!t){$.ui.msgbox({msg:"请选择文档"});return}if(!!v&&!!t){window.location.href=window.location.origin+"/"+t}});if(m){$.on(m,$.touch_EV.start_EV,function(){var w=r();var u=r("inp");var v=window.location.pathname;var t=document.documentElement.getAttribute("data-create-doc");window.removeEventListener("keydown",g);if(t){window.location.reload()}c.style.display="block";w.src=v=="/"?"/static/inner.html":"/view"+window.location.pathname;a.removeAttribute("hidden");m.setAttribute("hidden",true);k.setAttribute("hidden",true);b.removeAttribute("disabled");d.removeAttribute("disabled");document.documentElement.removeAttribute("data-create-doc")})}if(a){$.on(a,$.touch_EV.start_EV,function(){var u=r();var t=r("inp");$.ajax({url:"/edit",type:"post",data:{projectId:d.value},dataType:"json",success:function(v){if(v.status){u.src="/edit"+window.location.pathname;window.addEventListener("keydown",g,false);m.removeAttribute("hidden");k.removeAttribute("hidden");a.setAttribute("hidden",true);p.setAttribute("hidden",true);b.disabled=d.disabled=true}else{$.ui.mask.show({tipText:'<span style="color:#fff;">错误:</span>'+v.msg,autoHide:3000})}}})})}if(k){$.on(k,$.touch_EV.start_EV,function(){var z=r();var w=r("inp");var u=document.documentElement.getAttribute("data-create-doc");var v=document.documentElement.getAttribute("data-doc-category");var y=b.value;var x=d.value;var t=z.contentWindow.editor.session.getValue();if(u){$.ajax({url:"/create-project/",type:"post",timeout:2000,data:{departmentId:y,name:x,content:t},success:function(A){if(A.status){l(A.msg,A.url)}else{$.ui.mask.show({tipText:A.msg,autoHide:2000,showCallBack:function(){window.location.reload()}})}}})}else{$.ajax({url:"/view/"+x,type:"post",data:{projectId:x,content:t},success:function(A){if(A.status){l(A.msg,A.url)}else{$.ui.mask.show({tipText:A.msg,autoHide:2000,showCallBack:function(){window.location.reload()}})}}})}})}if(p){$.on(p,$.touch_EV.start_EV,function(){var t=b.innerHTML;var v='<div style="padding-left:5px;"><select>'+t+"</select></div>";var u=['<div style="">','    <div style="display:flex;align-items:center; margin: 0 0 8px">',"        <div>选择部门:</div>","        <div>"+v+"</div>","    </div>",'    <div style="display:flex;align-items:center">',"        <div>文档名称:</div>",'        <div style="padding-left:5px"><input type="text" required /></div>',"    </div>","</div>"].join("");$.ui.msgbox({title:"创建文档",type:"confirm",msg:u,callBack:{preInput:function(){var z=this.content;var w=z.querySelectorAll("select")[0];var y=z.querySelectorAll("input")[0];var x=this.okBtn;x.disabled=true;x.classList.add("disabled");this.inp=y;this.slt=w;$.on(y,"input",function(){if(this.value&&w.value){x.removeAttribute("disabled");x.classList.remove("disabled")}else{x.disabled=true;x.classList.add("disabled")}});$.on(w,"change",function(){if(this.value&&y.value){x.removeAttribute("disabled");x.classList.remove("disabled")}else{x.disabled=true;x.classList.add("disabled")}})},okFn:function(){for(var x=0,w=b.options.length;x<w;x++){if(b.options[x].value==this.slt.value){b.options[x].selected=true}}var y='<option>选择文档</option><option value="'+this.inp.value+'" selected>'+this.inp.value+"</option>";d.innerHTML=y;b.disabled=d.disabled=true;p.setAttribute("hidden",true);a.setAttribute("hidden",true);m.removeAttribute("hidden");k.removeAttribute("hidden");h=document.getElementById("tool-nav");h.innerHTML="";r().src="/static/create.html";document.documentElement.setAttribute("data-create-doc",true)},cancelFn:function(){}}})})}},false);
